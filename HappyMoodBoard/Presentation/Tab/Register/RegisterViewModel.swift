//
//  RegisterViewModel.swift
//  HappyMoodBoard
//
//  Created by 홍다희 on 2023/12/27.
//

import Foundation

import RxSwift

struct PostDomain {
    let id: Int?
    let comments: String?
    let tag: Tag?
    let image: UIImage?
}

extension PostDomain {
    init() {
        self.init(id: nil, comments: nil, tag: nil, image: nil)
    }
}

final class RegisterViewModel: ViewModel {
    
    enum Constants {
        static let maxLength = 1000
        static let maxLengthAlertMessage = "최대 1,000자까지만 작성할 수 있어요."
    }
    
    struct Input {
        let textDidChanged: Observable<Void>
        let textChanged: Observable<String?>
        let backButtonTapped: Observable<Void>
        let navigatToBackOkActionTapped: Observable<Void>
        let registerButtonTapped: Observable<Void>
        let imageViewTapped: Observable<UITapGestureRecognizer>
        let deleteTagButtonTapped: Observable<Void>
        let deleteImageButtonTapped: Observable<Void>
        let deleteImageOkActionTapped: Observable<Void>
        let addImageButtonTapped: Observable<Void>
        let addTagButtonTapped: Observable<Void>
        let tagSelected: Observable<Tag?>
        let keyboardButtonTapped: Observable<Void>
        let keyboardWillShow: Observable<Notification>
        let imageSelected: Observable<[UIImagePickerController.InfoKey: Any]>
    }
    
    struct Output {
        let textDidChanged: Observable<Void>
        let canRegister: Observable<Bool>
        let showNavigateToBackAlert: Observable<Bool>
        let showImagePicker: Observable<Bool>
        let shwoDeleteImageAlert: Observable<Void>
        let showTagListViewController: Observable<Void>
        let showFullImageViewController: Observable<UIImage?>
        let post: Observable<PostDomain>
        let keyboard: Observable<Void>
        let showLoadingView: Observable<Bool>
        let navigateToDetail: Observable<Int?>
        let error: Observable<String>
        let navigateToBack: Observable<Void>
    }
    
    private let post: PostDomain
    
    init(post: PostDomain = .init()) {
        self.post = post
    }
    
    func transform(input: Input) -> Output {
        let image = Observable.merge(
            input.imageSelected
                .map { $0[.editedImage] as? UIImage },
            input.deleteImageOkActionTapped
                .map { _ in nil }
        )
            .startWith(self.post.image)

        let text = input.textChanged
            .filter { $0 != RegisterViewController.Constants.textViewPlaceholder }
            .startWith(self.post.comments)
            .distinctUntilChanged()
            .scan(String()) { previous, new -> String? in
                // 최대 글자수 초과시 초과된 부분은 입력되지 않음
                guard new?.count ?? 0 <= Constants.maxLength else { return previous }
                return new
            }
        
        let showTextMaxLengthAlert = text
            .filter { ($0?.count ?? 0) == Constants.maxLength }
            .map { _ in "최대 1,000자까지만 작성할 수 있어요." }
        
        let tag = Observable.merge(
            input.tagSelected,
            input.deleteTagButtonTapped.map { _ in nil }
        )
            .startWith(self.post.tag)
        
        let textAndTagAndImage = Observable.combineLatest(text, tag, image)
        
        let post = Observable.combineLatest(
            Observable.just(self.post),
            textAndTagAndImage
        ) { post, textAndTagAndImage -> PostDomain in
            return PostDomain(
                id: post.id,
                comments: textAndTagAndImage.0,
                tag: textAndTagAndImage.1,
                image: textAndTagAndImage.2
            )
        }
            .startWith(self.post)
        
        let showImagePicker = input.addImageButtonTapped
            .withLatestFrom(image)
            .map { $0 == nil ? true : false }
        
        // '뒤로가기' 눌렀을 때, 글씨, 이미지 등록, 태그 등록 중 1가지라도 되어있을 경우
        // "작성한 내용이 저장되지 않아요.\n정말 뒤로 가시겠어요?" 팝업 노출
        let showNavigateToBackAlert = input.backButtonTapped.withLatestFrom(post)
            .map { post in
                if post.comments == nil && post.tag == nil && post.image == nil {
                    return false
                }
                return true
            }
            .debug("뒤로가기")
        
        let textValid = post
            .map(checkTextValid)
            .startWith(false)
            .distinctUntilChanged()
        
        let imageValid = post
            .map(checkImageValid)
            .startWith(false)
            .distinctUntilChanged()
        
        // 발행 버튼 클릭시 애니메이션
        let isLoading: BehaviorSubject<Bool> = .init(value: false)
        
        // 본문이 1글자 이상 존재하거나 사진이 1개 등록인 상태일 경우
        // 로딩 중이 아니라면
        // 발행 버튼 활성화
        let canRegister = Observable.combineLatest(textValid, imageValid, isLoading) { $0 || $1 && !$2 }
        
        // 발행 버튼 클릭시 이미지 업로드
        let uploadImage = input.registerButtonTapped.withLatestFrom(post)
            .do(onNext: { _ in
                isLoading.onNext(true)
            })
            .flatMapLatest { post -> Observable<UpdatePostParameters> in
                if let image = post.image {
                    let path = "\(PreferencesService.shared.memberId ?? .init())/\(Date().timeIntervalSince1970.description)"
                    return FirebaseStorageService.shared.rx.upload(image: image, forPath: path)
                        .map {
                            UpdatePostParameters(
                                postId: post.id,
                                tagId: post.tag?.id,
                                comments: post.comments,
                                imagePath: $0
                            )
                        }
                } else {
                    return .just(
                        .init(
                            postId: post.id,
                            tagId: post.tag?.id,
                            comments: post.comments,
                            imagePath: nil
                        )
                    )
                }
            }
            .debug("이미지 업로드")
            .share()
        
        // 이미지 업로드 후 게시글 등록 또는 수정
        let result = uploadImage
            .map {
                // 게시글 등록
                if $0.postId != nil {
                    return PostTarget.update($0)
                }
                // 게시글 수정
                return PostTarget.create($0)
            }
            .flatMapLatest {
                ApiService().request(type: UpdatePostResponse.self, target: $0)
                    .materialize()
            }
            .share()
            .debug("게시글 등록")
            .delay(.seconds(3), scheduler: MainScheduler.instance) // 딜레이
            .do(onNext: { _ in
                isLoading.onNext(false)
            })
        
        let apiSuccess = result.elements()
            .map { $0?.postId }
        
        let apiFailure = result.errors()
            .map { $0.localizedDescription }
            
        let showFullImageViewController = input.imageViewTapped.withLatestFrom(image)
            .asObservable()
        
        let errorMessage = Observable.merge(
            apiFailure,
            showTextMaxLengthAlert
        )
        
        return .init(
            textDidChanged: input.textDidChanged,
            canRegister: canRegister,
            showNavigateToBackAlert: showNavigateToBackAlert,
            showImagePicker: showImagePicker,
            shwoDeleteImageAlert: input.deleteImageButtonTapped,
            showTagListViewController: input.addTagButtonTapped,
            showFullImageViewController: showFullImageViewController,
            post: post,
            keyboard: input.keyboardButtonTapped,
            showLoadingView: isLoading,
            navigateToDetail: apiSuccess,
            error: errorMessage,
            navigateToBack: input.navigatToBackOkActionTapped
        )
    }
    
    private func checkTextValid(_ post: PostDomain) -> Bool {
        (post.comments ?? "").count > 0
    }
    
    private func checkImageValid(_ post: PostDomain) -> Bool {
        post.image != nil
    }
    
}
